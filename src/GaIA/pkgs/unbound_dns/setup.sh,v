head	1.4;
access;
symbols;
locks; strict;
comment	@# @;


1.4
date	2013.05.29.10.25.15;	author root;	state Exp;
branches;
next	1.3;

1.3
date	2013.05.29.06.32.32;	author root;	state Exp;
branches;
next	1.2;

1.2
date	2013.05.24.16.23.43;	author root;	state Exp;
branches;
next	1.1;

1.1
date	2013.05.24.16.14.23;	author root;	state Exp;
branches;
next	;


desc
@@


1.4
log
@*** empty log message ***
@
text
@#!/bin/sh
#
# $Header: /lan/ssi/projects/UNItools/src/SPLAT/NGX/pkgs/unbound_dns/setup.sh,v 1.3 2013/05/29 06:32:32 root Exp $
#

#
# Vars
#
UNBOUNDUSER=unbound
UNBOUNDGROUP="${UNBOUNDUSER}"
ROOTDIR="/home/${UNBOUNDUSER}"

PATH=$PATH:$ROOTDIR/bin

case $1 in
	install)

		FOUND=`clish -c "show user $UNBOUNDUSER" 2>&1	|
			awk '$3 == "'${ROOTDIR}'" {
				print "TRUE"
			}'`

		case $FOUND in
			TRUE)	echo "user '$UNBOUNDUSER' exists run $0 uninstall, bye"
				exit 1
			;;
			"")	:
			;;
			*)
			;;
		esac

		cat <<- EOF | clish 
		lock database override
		add user $UNBOUNDUSER uid 1004 homedir $ROOTDIR
		set user $UNBOUNDUSER shell /sbin/nologin
		save config
		quit
EOF
		
		#
		# Jeg er ikke sikker på at det er den rigtige måde at gøre det følgende på
		#

		# Add start/stop script
		INIT=$ROOTDIR/etc/unbound.init
		cp $INIT /etc/init.d/unbound
		chkconfig --add unbound
		chmod 555 /etc/init.d/unbound

		# Preserve old file
		test -f /etc/sysconfig/syslog.org || {
			/bin/cp /etc/sysconfig/syslog /etc/sysconfig/syslog.org
		}
		
		#
		# Add -a $ROOTDIR/dev/log to /etc/sysconfig/syslog
		#
		. /etc/sysconfig/syslog.org

		SYSLOGD_OPTIONS="${SYSLOGD_OPTIONS} -a $ROOTDIR/dev/log"

		sed "s%^SYSLOGD_OPTIONS.*%SYSLOGD_OPTIONS=\"${SYSLOGD_OPTIONS}\"%" /etc/sysconfig/syslog.org > /tmp/syslog

		/bin/mv /tmp/syslog /etc/sysconfig/syslog
		/etc/init.d/syslog restart

		# A copy is already here so it doesn't matter if wget fails
		cd $ROOTDIR/etc/unbound
		wget ftp://ftp.internic.net/domain/named.cache

		cd  $ROOTDIR/bin
		$ROOTDIR/bin/unbound-control-setup

		/etc/init.d/unbound start
	;;
	uninstall)

		chkconfig --del unbound
		/bin/rm -f /etc/init.d/unbound

		test -f /etc/sysconfig/syslog.org || {
			/bin/cp /etc/sysconfig/syslog /etc/sysconfig/syslog.org
		}

		#
		# Remove -a $ROOTDIR/dev/log from syslog options by reversing to vanilla
		#

		SYSLOGD_OPTIONS="-m 0 -z 515"

		sed "s%^SYSLOGD_OPTIONS.*%SYSLOGD_OPTIONS=\"${SYSLOGD_OPTIONS}\"%" /etc/sysconfig/syslog.org > /tmp/syslog

		/bin/mv /tmp/syslog /etc/sysconfig/syslog
		/etc/init.d/syslog restart

		# Remove user -- which will remove HOME as well

		cd /

		cat <<- EOF | clish 
		lock database override
		delete user $UNBOUNDUSER
		save config
		quit
EOF

	;;
esac
@


1.3
log
@*** empty log message ***
@
text
@d3 1
a3 1
# $Header$
d57 1
a57 1
		# add "-a /var/opt/UNIdns/dev/log" to SYSLOGD_OPTIONS
d59 6
a64 2
		# sed 's%^SYSLOGD_OPTIONS\(.*\)"%SYSLOGD_OPTIONS\1 -a \home/unbound/dev/log"%' /etc/sysconfig/syslog.org > /tmp/syslog
		sed "s%^SYSLOGD_OPTIONS\(.*\)%SYSLOGD_OPTIONS\1\" -a $ROOTDIR/dev/log\"%" /etc/sysconfig/syslog.org > /tmp/syslog
a65 1
		diff /etc/sysconfig/syslog /etc/sysconfig/syslog.org
a77 8
		# Remove user -- which will remove HOME as well

		cat <<- EOF | clish 
		lock database override
		delete user $UNBOUNDUSER
		save config
		quit
EOF
d85 9
a93 1
		sed "s%\" -a $ROOTDIR/dev/log\"%%" /etc/sysconfig/syslog > /tmp/syslog
d97 1
a97 2
	;;
esac
d99 1
d101 6
d108 2
@


1.2
log
@*** empty log message ***
@
text
@d3 1
a3 1
# $Header: /lan/ssi/projects/UNItools/src/SPLAT/NGX/pkgs/unbound_dns/setup.sh,v 1.1 2013/05/24 16:14:23 root Exp root $
a8 1
ROOTDIR="/var/opt/UNIdns"
d10 4
a13 1
UNBOUNDGROUP=unbound
d18 26
a43 3
		# Add user and group
		groupadd $UNBOUNDUSER
		useradd -d $ROOTDIR -M -g $UNBOUNDUSER -s /bin/false $UNBOUNDUSER
d59 5
a63 3
		sed 's%^SYSLOGD_OPTIONS\(.*\)"%SYSLOGD_OPTIONS\1/ -a \/var\/opt\/UNIdns\/dev\/log"%' /etc/sysconfig/syslog > /tmp/syslog
		/bin/mv /tmp/syslog
		/etc/init.d/syslogd restart
d67 1
a68 10
		if type wget 1>/dev/null 2>&1; then
			wget ftp://ftp.internic.net/domain/named.cache
		else
			echo "wget not found in PATH, using old copy of named.cache"
			echo "download yourself with"
			echo "cd `pwd`"
			echo "wget ftp://ftp.internic.net/domain/named.cache"
		fi

		echo running $ROOTDIR/bin/unbound-control-setup ...
a71 2
		echo running /etc/init.d/unbound start

a72 3

		echo all done, bye

d75 1
a75 2
		echo "Removing user and group ... "
		userdel $UNBOUNDUSER
d77 6
a82 2
		echo "stopping services ... "
		/etc/init.d/unbound stop
a83 1
		echo "removing init script ... "
a86 1
		echo "removing -a ... /dev/log from /etc/sysconfig/syslog ... "
d90 3
d94 2
a95 1
		echo "original syslog seems to be in /etc/sysconfig/syslog.org ... "
a96 2
		sed 's%-a /var/opt/UNIdns/dev/log%%' /etc/sysconfig/syslog > /tmp/syslog
		/bin/mv /tmp/syslog
a97 6
		echo rstarting syslog
		/etc/init.d/syslogd restart

		echo done, bye
	;;
esac
@


1.1
log
@Initial revision
@
text
@d3 1
a3 1
# $Header$
a39 1
		wget ftp://ftp.internic.net/domain/named.cache
d41 10
d54 2
d57 3
d62 1
a62 1
		# Remove user and group
d64 5
d72 1
d76 3
d81 2
d85 1
a88 2


@
